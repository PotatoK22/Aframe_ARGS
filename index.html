<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://quadjr.github.io/aframe-gaussian-splatting/index.js"></script>
    // 性能分级
    <script>
      function getDevicePerformanceLevel() {
        const ua = navigator.userAgent;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
        const deviceMemory = navigator.deviceMemory || 4;
        const hardwareConcurrency = navigator.hardwareConcurrency || 4;

        if (!isMobile) {
          return "high"; // 桌面设备默认高性能
        }

        // 调整性能分级标准
        if (deviceMemory >= 6 && hardwareConcurrency >= 6) {
          return "high";
        } else if (deviceMemory >= 4 && hardwareConcurrency >= 4) {
          return "medium";
        } else {
          return "low";
        }
      }

      window.addEventListener("load", () => {
        const performanceLevel = getDevicePerformanceLevel();
        const scene = document.querySelector("a-scene");

        let canvasWidth, canvasHeight;
        switch (performanceLevel) {
          case "high":
            canvasWidth = 2048; // 提升至2K分辨率
            canvasHeight = 1152; // 保持16:9比例
            break;
          case "medium":
            canvasWidth = 1500;
            canvasHeight = 844;
            break;
          case "low":
            canvasWidth = 1280;
            canvasHeight = 720;
            break;
        }

        // 更新 AR.js 配置
        const arSystem = scene.systems.arjs;
        if (arSystem) {
          arSystem.arProfile.canvasWidth = canvasWidth;
          arSystem.arProfile.canvasHeight = canvasHeight;
        }

        console.log(
          `设备性能级别: ${performanceLevel}, 分辨率: ${canvasWidth}x${canvasHeight}`
        );
      });
    </script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .debug-info {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        font-family: monospace;
        z-index: 1000;
        max-width: 90vw;
        font-size: 14px;
        border-radius: 8px;
        word-wrap: break-word;
      }
    </style>
    <script>
      async function testModelAccess() {
        const modelUrl =
          "https://huggingface.co/datasets/Kopamine/ForAframeSplat/resolve/main/model001.splat";
        try {
          const response = await fetch(modelUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const blob = await response.blob();
          document.querySelector(
            "#debug-info"
          ).innerHTML += `<br>Model file size: ${(
            blob.size /
            1024 /
            1024
          ).toFixed(2)}MB`;
          return true;
        } catch (error) {
          document.querySelector(
            "#debug-info"
          ).innerHTML += `<br>Error accessing model: ${error.message}`;
          console.error("Model access error:", error);
          return false;
        }
      }

      AFRAME.registerComponent("marker-handler", {
        init: function () {
          this.marker = this.el;

          this.marker.addEventListener("markerFound", () => {
            document.querySelector("#debug-info").innerHTML =
              "Marker Found! Loading model...";
            const model = this.el.querySelector("[gaussian_splatting]");
            if (model) {
              model.setAttribute("visible", "true");
              testModelAccess();
            }
          });

          this.marker.addEventListener("markerLost", () => {
            document.querySelector("#debug-info").innerHTML =
              "Marker Lost - Please show the Hiro marker again";
            const model = this.el.querySelector("[gaussian_splatting]");
            if (model) {
              model.setAttribute("visible", "false");
            }
          });
        },
      });

      AFRAME.registerComponent("splat-loader", {
        init: function () {
          this.el.addEventListener("model-loaded", () => {
            document.querySelector("#debug-info").innerHTML +=
              "<br>Model loaded successfully!";
            console.log("Model loaded event fired");
          });

          this.el.addEventListener("model-error", (error) => {
            document.querySelector(
              "#debug-info"
            ).innerHTML += `<br>Error loading model: ${error.detail}`;
            console.error("Model loading error:", error);
          });

          console.log("Splat loader component initialized");
          document.querySelector("#debug-info").innerHTML +=
            "<br>Initializing splat loader...";
        },
      });
    </script>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <div id="debug-info" class="debug-info">等待识别Hiro marker...</div>

    <a-scene
      embedded
      arjs="sourceType: webcam; 
            debugUIEnabled: true; 
            trackingMethod: best; 
            areaLearningButton: false;
            markersAreaEnabled: false;
            trackingBackend: artoolkit;
            maxDetectionRate: 60;
            canvasWidth: 1920;
            canvasHeight: 1080;"
      renderer="antialias: true;
               logarithmicDepthBuffer: true;
               precision: high;
               physicallyCorrectLights: true;
               sortObjects: true;
               colorManagement: true;"
      vr-mode-ui="enabled: false"
    >
      <a-marker
        preset="hiro"
        marker-handler
        smooth="true"
        smoothcount="5"
        smoothtolerance="0.01"
        smooththreshold="2"
      >
        <a-entity id="model-wrapper" position="0 0 0">
          <a-entity
            id="splat-model"
            gaussian_splatting="
              src: https://huggingface.co/datasets/Kopamine/ForAframeSplat/resolve/main/model001.splat;
              autoLoad: true;"
            scale="0.5 0.5 0.5"
            position="0 0 0"
            rotation="0 0 0"
            visible="true"
            splat-loader
          >
          </a-entity>
        </a-entity>

        <a-box position="0 0.1 0" scale="0.2 0.2 0.2" color="red"> </a-box>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      window.addEventListener("load", async () => {
        console.log("Page loaded, checking model access...");
        document.querySelector("#debug-info").innerHTML +=
          "<br>Checking model access...";
        await testModelAccess();

        // 性能监控和自适应质量调整
        const scene = document.querySelector("a-scene");
        const renderer = scene.renderer;

        // 检查设备性能
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
          renderer.setPixelRatio(
            window.devicePixelRatio > 2 ? 2 : window.devicePixelRatio
          );
        } else {
          renderer.setPixelRatio(window.devicePixelRatio);
        }

        // 监控 FPS
        let lastTime = performance.now();
        let frames = 0;

        function checkPerformance() {
          frames++;
          const currentTime = performance.now();

          if (currentTime - lastTime >= 1000) {
            const fps = frames;
            frames = 0;
            lastTime = currentTime;

            if (fps < 30) {
              const currentPixelRatio = renderer.getPixelRatio();
              if (currentPixelRatio > 1) {
                renderer.setPixelRatio(currentPixelRatio - 0.5);
              }
            }
          }

          requestAnimationFrame(checkPerformance);
        }

        checkPerformance();
      });
    </script>
  </body>
</html>
